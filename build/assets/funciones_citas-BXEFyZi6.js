document.addEventListener("DOMContentLoaded",()=>{const l=new bootstrap.Modal(document.getElementById("crearCitaModal")),u=new bootstrap.Modal(document.getElementById("editarCitaModal")),m=document.getElementById("calendario");new FullCalendar.Calendar(m,{selectable:!0,editable:!0,droppable:!0,dayMaxEvents:!0,height:800,contentHeight:780,aspectRatio:3,nowIndicator:!0,locale:"es",initialView:"dayGridMonth",initialDate:new Date,events:"/obtenerEvento",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,listMonth"},views:{dayGridMonth:{buttonText:"Mes"},timeGridWeek:{buttonText:"Semana"}},eventDragStart(n){zonaEliminar.classList.add("bg-danger","text-white"),zonaEliminar.innerHTML='<i class=" fas fa-trash-restore-alt"></i>'},eventDragStop(n){const t=n.event,e=zonaEliminar.getBoundingClientRect(),{clientX:r,clientY:a}=n.jsEvent;zonaEliminar.classList.remove("bg-danger","text-white"),zonaEliminar.innerHTML='<i class="fas fa-trash"></i>',r>=e.left&&r<=e.right&&a>=e.top&&a<=e.bottom&&Swal.fire({title:"¿Estás seguro de eliminar esta cita?",text:"No podrás revertir esta acción.",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"}).then(s=>{if(s.isConfirmed){const d=t.extendedProps.id_ct;fetch(`/citas/eliminar/${d}`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({})}).then(i=>{if(!i.ok)throw new Error("Error al eliminar la cita");return i.json()}).then(i=>{Swal.fire({toast:!0,position:"top-end",icon:"success",title:"Eliminado",text:"La cita fue eliminada",showConfirmButton:!1,timer:3e3,timerProgressBar:!0}),t.remove()}).catch(i=>{Swal.fire("Error",i.message,"error")})}})},dateClick:n=>{document.getElementById("fecha_cita").value=n.dateStr,l.show()},eventDrop:n=>{Swal.fire({title:"¿Estás seguro de cambiar la fecha u hora?",icon:"question",showCancelButton:!0,confirmButtonText:"Sí, cambiar",cancelButtonText:"Cancelar"}).then(t=>{if(!t.isConfirmed){n.revert();return}const e=n.event,r=e.extendedProps.id_ct,a=new Date(e.start),c=e.end?new Date(e.end):null,s=a.toISOString().split("T")[0],d=a.toTimeString().slice(0,5),i=c?c.toTimeString().slice(0,5):null;fetch(`/citas/actualizarfecha/${r}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({fecha_cita:s,hora_inicio:d,hora_fin:i})}).then(async o=>{if(!o.ok){const h=await o.json();throw new Error(h.message||"Error inesperado")}return o.json()}).then(o=>{Swal.fire("¡Éxito!",o.mensaje,"success")}).catch(o=>{Swal.fire("Error",`No se pudo actualizar:
${o.message}`,"error"),n.revert()})})},eventClick:n=>{const t=n.event,e=new Date(t.start),r=t.end?new Date(t.end):null,a=o=>o.toString().padStart(2,"0"),c=`${a(e.getHours())}:${a(e.getMinutes())}`,s=r?`${a(r.getHours())}:${a(r.getMinutes())}`:"",d=e.toISOString().split("T")[0],i=t.extendedProps.id_ct;document.getElementById("editar_usuario").value=t.extendedProps.id_usr,document.getElementById("editar_cliente").value=t.extendedProps.id_cli,document.getElementById("editar_motivo").value=t.title,document.getElementById("editar_fecha_cita").value=d,document.getElementById("editar_hora_inicio").value=c,document.getElementById("editar_hora_fin").value=s,document.getElementById("formActualizarCita").action=`/citas/actualizar/${i}`,u.show()}}).render()});
